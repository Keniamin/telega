#!/usr/bin/env python
# -*- coding: utf8 -*-
from time import sleep
from datetime import datetime, timedelta

import telega.tasks as tasks

ERROR_SLEEP = 10
MAX_ERROR_SLEEP = 300

config = tasks.config
db = tasks.db


def processed(task):
    db.remove('Tasks', task['id'])

def main():
    time_to_sleep = 0
    while True:
        try:
            db.remove_old_tasks()

            task = db.get_next_task()
            if task['processor'] is None:
                processed(task)
                continue

            may_sleep = task['time'] - datetime.utcnow()
            if may_sleep.total_seconds() > 1:
                sleep(int(may_sleep))
                continue

            target = task['processor'].prepare_target(task['target'])
            if target is None:
                processed(task)
            elif task['processor'].run_task(target):
                processed(task)
        except Exception as exc:
            if time_to_sleep < MAX_ERROR_SLEEP:
               time_to_sleep += ERROR_SLEEP
            sleep(time_to_sleep)

if __name__ == "__main__":
    main()
